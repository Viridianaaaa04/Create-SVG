<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cake Topper SVG Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.select.js@3.0/dist/svg.select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.draggable.js@3.0/dist/svg.draggable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .layer-selected { background-color: #e0e7ff !important; }
        .dragging { opacity: 0.5; background: #c7d2fe; }
        .drag-over { border-top: 2px solid #4f46e5; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="flex flex-col md:flex-row h-screen">
        <!-- Left Panel: Controls -->
        <aside class="w-full md:w-96 bg-white p-6 border-r border-gray-200 flex flex-col space-y-6 overflow-y-auto">
            <div class="flex items-center space-x-3">
                <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <h1 class="text-2xl font-bold text-gray-900">SVG Creator</h1>
            </div>

            <!-- Prompt Section -->
            <div>
                <label for="prompt" class="block text-sm font-medium text-gray-700 mb-1">1. Enter Your Design Prompt</label>
                <textarea id="prompt" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., A happy dinosaur with a birthday hat"></textarea>
            </div>
            
            <!-- NEW: Constraints Section -->
            <div>
                 <label class="block text-sm font-medium text-gray-700 mb-1">2. Set Constraints (Optional)</label>
                 <div class="grid grid-cols-2 gap-4">
                     <div>
                         <label for="max-layers" class="text-xs text-gray-600">Max Layers</label>
                         <input type="number" id="max-layers" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="e.g., 5">
                     </div>
                     <div>
                         <label for="max-colors" class="text-xs text-gray-600">Max Colors</label>
                         <input type="number" id="max-colors" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="e.g., 3">
                     </div>
                 </div>
            </div>

            <!-- Generate Button -->
            <button id="generate-btn" class="w-full flex items-center justify-center bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-300 disabled:cursor-not-allowed">
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="generate-btn-text">Generate Design</span>
            </button>
            <p id="error-message" class="text-sm text-red-600"></p>

            <!-- Layers Panel -->
            <div class="flex-grow flex flex-col">
                <h2 class="text-sm font-medium text-gray-700 mb-2">3. Edit Layers</h2>
                <div id="layers-panel" class="flex-grow bg-gray-50 border rounded-md p-2 space-y-1 overflow-y-auto">
                    <p class="text-gray-400 text-center text-sm py-4">Your layers will appear here...</p>
                </div>
            </div>

            <!-- Edit Controls -->
            <div id="edit-controls" class="hidden space-y-4">
                <div>
                    <label for="color-picker" class="block text-sm font-medium text-gray-700 mb-1">Layer Color</label>
                    <input type="color" id="color-picker" class="w-full h-10 p-1 border border-gray-300 rounded-md cursor-pointer">
                </div>
                <button id="download-btn" disabled class="w-full bg-green-600 text-white font-semibold py-2.5 px-4 rounded-md shadow-sm hover:bg-green-700 disabled:bg-green-300">Download SVG</button>
            </div>
        </aside>

        <!-- Right Panel: SVG Canvas -->
        <main class="flex-1 bg-gray-100 p-4 md:p-8 flex items-center justify-center">
            <div id="svg-canvas" class="w-full h-full max-w-4xl max-h-4xl bg-white rounded-lg shadow-inner border border-gray-200 aspect-square"></div>
        </main>
    </div>

    <script>
        // --- DOM Elements ---
        const promptEl = document.getElementById('prompt');
        const maxLayersEl = document.getElementById('max-layers');
        const maxColorsEl = document.getElementById('max-colors');
        const generateBtn = document.getElementById('generate-btn');
        const generateBtnText = document.getElementById('generate-btn-text');
        const spinner = document.getElementById('spinner');
        const errorMessage = document.getElementById('error-message');
        const layersPanel = document.getElementById('layers-panel');
        const editControls = document.getElementById('edit-controls');
        const colorPicker = document.getElementById('color-picker');
        const downloadBtn = document.getElementById('download-btn');
        const svgCanvasEl = document.getElementById('svg-canvas');

        // --- State ---
        let svgDraw;
        let selectedElement = null;
        let draggedItem = null;

        // --- SVG.js Initialization ---
        function initializeCanvas() {
            if (svgDraw) svgDraw.remove();
            svgDraw = SVG().addTo('#svg-canvas').size('100%', '100%');
        }
        
        initializeCanvas();

        // --- API Call ---
        async function generateSVGData(userPrompt, maxLayers, maxColors) {
            setLoading(true);
            errorMessage.textContent = '';
            
            const apiUrl = `/.netlify/functions/generate-svg`;

            try {
                let response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: userPrompt, maxLayers, maxColors })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `API error: ${response.statusText}`);
                }

                const result = await response.json();
                return result;

            } catch (error) {
                console.error("Error calling serverless function:", error);
                errorMessage.textContent = error.message || "Failed to generate design. Please try again.";
                return null;
            } finally {
                setLoading(false);
            }
        }

        // --- UI & State Management ---
        function setLoading(isLoading) {
            generateBtn.disabled = isLoading;
            spinner.classList.toggle('hidden', !isLoading);
            generateBtnText.textContent = isLoading ? 'Generating...' : 'Generate Design';
        }

        function clearWorkspace() {
            initializeCanvas();
            layersPanel.innerHTML = '<p class="text-gray-400 text-center text-sm py-4">Your layers will appear here...</p>';
            downloadBtn.disabled = true;
            editControls.classList.add('hidden');
            selectedElement = null;
        }

        // --- Layer Panel & Drag-n-Drop ---
        function updateLayerPanel() {
            layersPanel.innerHTML = '';
            const elements = svgDraw.children().slice().reverse(); // Reverse to show top layer first
            
            if (elements.length === 0) {
                 layersPanel.innerHTML = '<p class="text-gray-400 text-center text-sm py-4">No layers to show.</p>';
                 return;
            }

            elements.forEach((el, index) => {
                const layerId = el.id();
                const layerDiv = document.createElement('div');
                layerDiv.className = 'p-2 rounded-md cursor-grab flex items-center justify-between hover:bg-gray-100';
                layerDiv.dataset.id = layerId;
                layerDiv.draggable = true;

                // Drag and Drop Event Listeners
                layerDiv.addEventListener('dragstart', handleDragStart);
                layerDiv.addEventListener('dragover', handleDragOver);
                layerDiv.addEventListener('dragleave', handleDragLeave);
                layerDiv.addEventListener('drop', handleDrop);
                layerDiv.addEventListener('dragend', handleDragEnd);

                const colorSwatch = document.createElement('span');
                colorSwatch.className = 'w-4 h-4 rounded-full inline-block mr-2 border pointer-events-none';
                colorSwatch.style.backgroundColor = el.attr('fill');

                const layerName = document.createElement('span');
                layerName.textContent = layerId;
                layerName.className = 'text-sm truncate flex-grow pointer-events-none';

                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center'
                wrapper.appendChild(colorSwatch);
                wrapper.appendChild(layerName);

                layerDiv.appendChild(wrapper);
                layersPanel.appendChild(layerDiv);
                
                if (selectedElement && selectedElement.id() === layerId) {
                    layerDiv.classList.add('layer-selected');
                }

                layerDiv.addEventListener('click', () => selectElement(el));
            });
        }
        
        function handleDragStart(e) {
            draggedItem = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            setTimeout(() => this.classList.add('dragging'), 0);
        }

        function handleDragOver(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }
        
        function handleDragLeave() {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.stopPropagation();
            if (draggedItem !== this) {
                const draggedId = draggedItem.dataset.id;
                const targetId = this.dataset.id;
                const draggedElement = SVG.get(draggedId);
                const targetElement = SVG.get(targetId);

                // Reorder SVG element
                draggedElement.insertAfter(targetElement);
                
                // Re-render layer panel in new order
                updateLayerPanel();
            }
        }
        
        function handleDragEnd() {
            document.querySelectorAll('#layers-panel div').forEach(item => {
                item.classList.remove('dragging', 'drag-over');
            });
            draggedItem = null;
        }

        function selectElement(el) {
            if (selectedElement) {
                selectedElement.selectize(false);
            }
            selectedElement = el;
            if (el) {
                el.selectize({ points: 'lt,rt,rb,lb,r,b', rotationPoint: false }).resize();
                el.draggable();
                colorPicker.value = el.attr('fill');
                editControls.classList.remove('hidden');
            } else {
                editControls.classList.add('hidden');
            }
            updateLayerPanel();
        }

        // --- SVG Rendering ---
        function renderSVG(svgData) {
            clearWorkspace();

            if (!svgData || !svgData.layers) {
                errorMessage.textContent = 'AI response was not in the correct format. Could not render.';
                return;
            }

            svgDraw.viewbox(svgData.viewBox || '0 0 500 500');

            svgData.layers.forEach(layer => {
                let element;
                if (layer.type === 'text') {
                    element = svgDraw.text(layer.attributes.text).attr(layer.attributes);
                } else if (layer.type === 'path') {
                    element = svgDraw.path(layer.attributes.d).attr(layer.attributes);
                }

                if (element) {
                    element.id(layer.id);
                    element.on('click', () => selectElement(element));
                }
            });

            updateLayerPanel();
            downloadBtn.disabled = false;
        }

        // --- Event Handlers ---
        generateBtn.addEventListener('click', async () => {
            const userPrompt = promptEl.value;
            const maxLayers = maxLayersEl.value || null;
            const maxColors = maxColorsEl.value || null;
            if (!userPrompt) {
                errorMessage.textContent = 'Please enter a prompt.';
                return;
            }
            const svgData = await generateSVGData(userPrompt, maxLayers, maxColors);
            if (svgData) {
                renderSVG(svgData);
            }
        });

        colorPicker.addEventListener('input', (e) => {
            if (selectedElement) {
                selectedElement.fill(e.target.value);
                updateLayerPanel();
            }
        });

        svgCanvasEl.addEventListener('click', (e) => {
            if (e.target === svgCanvasEl || e.target.tagName === 'svg') {
                selectElement(null);
            }
        });

        downloadBtn.addEventListener('click', () => {
            if (!svgDraw) return;
            if(selectedElement) selectedElement.selectize(false);
            const svgString = svgDraw.svg();
            if(selectedElement) selectElement(selectedElement);
            const blob = new Blob([svgString], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cake-topper.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>

