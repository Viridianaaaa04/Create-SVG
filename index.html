<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI SVG Creator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.select.js@3.0/dist/svg.select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.draggable.js@3.0/dist/svg.draggable.min.js"></script>
    <!-- Netlify Identity Widget for login/signup -->
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .tool-active { background-color: #e0e7ff; color: #4f46e5; }
        .layer-selected { background-color: #e0e7ff !important; }
        #paywall-overlay { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="flex flex-col md:flex-row h-screen relative">
        <!-- Left Panel: Controls -->
        <aside class="w-full md:w-96 bg-white p-6 border-r border-gray-200 flex flex-col space-y-4 overflow-y-auto">
            <div class="flex items-center justify-between">
                 <h1 class="text-2xl font-bold text-gray-900">SVG Creator Pro</h1>
                 <!-- Login/User status -->
                 <div id="user-status"></div>
            </div>
            
            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="tab-generate" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm tab-active">Generate</button>
                </nav>
            </div>
            
            <!-- Generate Panel -->
            <div id="panel-generate" class="space-y-4">
                 <div>
                    <label for="prompt" class="block text-sm font-medium text-gray-700 mb-1">1. Design Prompt</label>
                    <textarea id="prompt" rows="3" class="w-full p-2 border rounded-md" placeholder="e.g., A happy dinosaur"></textarea>
                </div>
                <button id="generate-btn" class="w-full flex items-center justify-center bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-indigo-700">Generate Design</button>
                <p id="error-message" class="text-sm text-red-600"></p>
            </div>

            <!-- Layers Panel -->
            <div class="flex-grow flex flex-col">
                <h2 class="text-sm font-medium text-gray-700 mb-2">2. Layers</h2>
                <div id="layers-panel" class="flex-grow bg-gray-50 border rounded-md p-2 space-y-1 overflow-y-auto">
                     <p class="text-gray-400 text-center text-sm py-4">Generate a design to see layers.</p>
                </div>
            </div>
            <button id="download-btn" disabled class="w-full bg-green-600 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-green-700">Download SVG</button>
        </aside>
        
        <!-- Right Panel: SVG Canvas -->
        <main class="flex-1 bg-gray-100 p-4 md:p-8 flex items-center justify-center relative">
            <div id="svg-canvas" class="w-full h-full bg-white rounded-lg shadow-inner border border-gray-200 aspect-square"></div>
        </main>

        <!-- NEW: Paywall Overlay -->
        <div id="paywall-overlay" class="hidden absolute inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center">
                <h2 id="paywall-title" class="text-2xl font-bold mb-4"></h2>
                <p id="paywall-message" class="text-gray-600 mb-6"></p>
                <button id="paywall-action-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-md hover:bg-indigo-700"></button>
                <button id="logout-btn" class="mt-4 text-sm text-gray-500 hover:underline">Log Out</button>
            </div>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // --- DOM Elements ---
        const userStatusEl = document.getElementById('user-status');
        const paywallOverlay = document.getElementById('paywall-overlay');
        const paywallTitle = document.getElementById('paywall-title');
        const paywallMessage = document.getElementById('paywall-message');
        const paywallActionBtn = document.getElementById('paywall-action-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const generateBtn = document.getElementById('generate-btn');
        const svgCanvasEl = document.getElementById('svg-canvas');
        const layersPanel = document.getElementById('layers-panel');
        const downloadBtn = document.getElementById('download-btn');
        
        // --- State ---
        let svgDraw;
        let hasAccess = false;
        
        // --- SVG Canvas Initialization ---
        function initializeCanvas() {
            if (svgDraw) svgDraw.remove();
            svgDraw = SVG().addTo('#svg-canvas').size('100%', '100%').viewbox(0,0,500,500);
        }

        // --- Authentication and Paywall Logic ---
        netlifyIdentity.on('login', user => {
            userStatusEl.innerHTML = `<span class="text-sm">${user.email}</span><button onclick="netlifyIdentity.logout()" class="ml-2 text-sm font-medium text-gray-600 hover:text-indigo-600">Log Out</button>`;
            checkUserAccess();
        });

        netlifyIdentity.on('logout', () => {
            userStatusEl.innerHTML = `<button onclick="netlifyIdentity.open()" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">Log In / Sign Up</button>`;
            hasAccess = false;
            showPaywall('login');
        });

        async function checkUserAccess() {
            const user = netlifyIdentity.currentUser();
            if (!user) {
                showPaywall('login');
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/check-access', {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${user.token.access_token}` }
                });

                const data = await response.json();

                if (response.ok && data.access) {
                    hasAccess = true;
                    paywallOverlay.classList.add('hidden');
                    console.log(`Access granted. Reason: ${data.reason}`);
                } else {
                    hasAccess = false;
                    showPaywall(data.reason || 'trial_expired');
                }
            } catch (error) {
                hasAccess = false;
                showPaywall('trial_expired');
                console.error('Failed to check access:', error);
            }
        }

        function showPaywall(reason) {
            paywallOverlay.classList.remove('hidden');
            logoutBtn.style.display = (reason !== 'login') ? 'block' : 'none';
            
            switch(reason) {
                case 'login':
                    paywallTitle.textContent = 'Welcome to SVG Creator Pro';
                    paywallMessage.textContent = 'Please log in or sign up to start your free 24-hour trial.';
                    paywallActionBtn.textContent = 'Log In / Sign Up';
                    paywallActionBtn.onclick = () => netlifyIdentity.open();
                    break;
                case 'trial_expired':
                default:
                    paywallTitle.textContent = 'Your Trial Has Expired';
                    paywallMessage.textContent = 'Please subscribe to our Pro plan to continue creating unlimited designs.';
                    paywallActionBtn.textContent = 'Subscribe to Pro';
                    paywallActionBtn.onclick = redirectToCheckout;
                    break;
            }
        }
        
        logoutBtn.onclick = () => netlifyIdentity.logout();

        async function redirectToCheckout() {
            const user = netlifyIdentity.currentUser();
            if (!user) return;

            paywallActionBtn.disabled = true;
            paywallActionBtn.textContent = 'Redirecting...';

            try {
                const response = await fetch('/.netlify/functions/create-checkout', {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${user.token.access_token}` }
                });
                if (!response.ok) throw new Error('Could not create checkout session.');
                
                const { sessionId } = await response.json();
                
                // IMPORTANT: Replace this with your Stripe Publishable Key
                const stripe = Stripe('YOUR_STRIPE_PUBLISHABLE_KEY'); 
                await stripe.redirectToCheckout({ sessionId });

            } catch (error) {
                console.error('Error redirecting to checkout:', error);
                alert('Could not connect to the payment page. Please try again.');
                paywallActionBtn.disabled = false;
                paywallActionBtn.textContent = 'Subscribe to Pro';
            }
        }

        // --- Modified Generate Function ---
        async function handleGenerateClick() {
            if (!hasAccess) {
                checkUserAccess();
                return;
            }
            
            const prompt = document.getElementById('prompt').value;
            if (!prompt) {
                alert("Please enter a design prompt.");
                return;
            }

            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';

            try {
                 const response = await fetch('/.netlify/functions/generate-svg', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${netlifyIdentity.currentUser().token.access_token}`
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to generate design.');
                }
                
                const svgData = await response.json();
                renderSVG(svgData);

            } catch (error) {
                console.error('Generation failed:', error);
                alert(`Error: ${error.message}`);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Design';
            }
        }

        function renderSVG(svgData) {
            initializeCanvas();
            layersPanel.innerHTML = '';
            if (!svgData || !svgData.layers) return;

            svgDraw.viewbox(svgData.viewBox || '0 0 500 500');

            svgData.layers.forEach(layer => {
                let element;
                if (layer.type === 'text') {
                    element = svgDraw.text(layer.attributes.text).attr(layer.attributes);
                } else if (layer.type === 'path') {
                    element = svgDraw.path(layer.attributes.d).attr(layer.attributes);
                }
                if (element) {
                    element.id(layer.id);
                    const layerDiv = document.createElement('div');
                    layerDiv.className = 'p-2 rounded-md hover:bg-gray-100 text-sm';
                    layerDiv.textContent = layer.id;
                    layersPanel.appendChild(layerDiv);
                }
            });
            downloadBtn.disabled = false;
        }
        
        downloadBtn.addEventListener('click', () => {
            if (!svgDraw) return;
            const blob = new Blob([svgDraw.svg()], { type: 'image/svg+xml' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'design.svg';
            a.click();
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeCanvas();
            const user = netlifyIdentity.currentUser();
            if (user) {
                 userStatusEl.innerHTML = `<span class="text-sm">${user.email}</span><button onclick="netlifyIdentity.logout()" class="ml-2 text-sm font-medium text-gray-600 hover:text-indigo-600">Log Out</button>`;
                 checkUserAccess();
            } else {
                userStatusEl.innerHTML = `<button onclick="netlifyIdentity.open()" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">Log In / Sign Up</button>`;
                showPaywall('login');
            }
            
            generateBtn.addEventListener('click', handleGenerateClick);
            
            // Initialize Netlify Identity Widget
            if (window.netlifyIdentity) {
                netlifyIdentity.init();
            }
        });
    </script>
</body>
</html>

